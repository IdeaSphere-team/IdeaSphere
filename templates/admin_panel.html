{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="text-center">管理员后台</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <h5 class="card-title">管理用户</h5>
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>用户名</th>
                                    <th>角色</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr>
                                    <td>{{ user.username }}</td>
                                    <td>{{ user.role }}</td>
                                    <td>
                                        {% if user.role == 'user' and session['role'] == 'admin' %}
                                        <button class="btn btn-success btn-sm" onclick="confirmUpgrade('{{ user.id }}')">提升为版主</button>
                                        {% elif user.role == 'moderator' and session['role'] == 'admin' %}
                                        <button class="btn btn-warning btn-sm" onclick="confirmDowngrade('{{ user.id }}')">降级为普通用户</button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-6 mb-4">
                        <h5 class="card-title">管理举报</h5>
                        {% if reports %}
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>用户</th>
                                    <th>帖子 ID</th>
                                    <th>原因</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for report in reports %}
                                <tr>
                                    <td>{{ report.id }}</td>
                                    <td>{{ report.user.username }}</td>
                                    <td>{{ report.post_id }}</td>
                                    <td>{{ report.reason }}</td>
                                    <td>{{ report.status }}</td>
                                    <td>
                                        <a href="{{ url_for('view_post', post_id=report.post_id) }}" class="btn btn-primary btn-sm">查看帖子</a>
                                        {% if report.status == 'pending' %}
                                        <button class="btn btn-danger btn-sm" onclick="handleReport('{{ report.id }}', 'valid')">已违规</button>
                                        <button class="btn btn-success btn-sm" onclick="handleReport('{{ report.id }}', 'invalid')">未违规</button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <div class="alert alert-info">暂无举报</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function confirmUpgrade(userId) {
        if (confirm('确定要提升该用户为版主吗？')) {
            window.location.href = '/upgrade_user/' + userId;
        }
    }

    function confirmDowngrade(userId) {
        if (confirm('确定要降级该用户为普通用户吗？')) {
            window.location.href = '/downgrade_user/' + userId;
        }
    }

    function handleReport(reportId, status) {
        fetch('/handle_report/' + reportId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({ status: status })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                alert('处理失败，请重试。');
            }
        });
    }
</script>
{% endblock %}