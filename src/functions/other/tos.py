import os
from datetime import datetime
import markdown
from flask import Blueprint, render_template

# 定义文件名和目录
TOS_FILE_NAME = 'tos.md'
CONFIG_DIR_NAME = 'config'
OTHER_DIR_NAME = 'other'

# 创建蓝图
tos_bp = Blueprint('tos', __name__, url_prefix='/tos')

# 设置默认的服务条款内容
DEFAULT_TOS_CONTENT = """
## 一、服务条款的接受

  1. 欢迎来到 IdeaSphere 论坛以下简称（ “本论坛”）。本论坛由 [公司名称 / 运营团队] 运营和管理。在使用本论坛服务之前，请您仔细阅读并充分理解本服务条款的全部内容。一旦您注册成为本论坛用户、使用本论坛的任何服务或访问本论坛的任何页面，即表示您已完全同意并接受本服务条款的各项条款，成为本论坛的用户。
  2. 如果您不同意本服务条款的任何内容，请您立即停止使用本论坛的服务。

## 二、用户资格

  1. 本论坛的服务仅面向符合中华人民共和国法律规定的具有完全民事权利能力和民事行为能力的自然人、法人和其他组织。如果您是自然人，您需年满 18 周岁且具备完全民事行为能力；如果您是未成年人，请在法定代理人的陪同和指导下使用本论坛服务。
  2. 如果您代表法人或其他组织使用本论坛服务，您必须保证有权使该法人或组织受本服务条款的约束。

## 三、账号注册与管理

  1. 用户注册时应按照本论坛的要求提供真实、准确、完整的信息，并在信息变更时及时更新。如因日期不真实、不准确、不完整或未及时更新而造成的任何损失或不利后果，本论坛不承担任何责任。
  2. 用户在注册账号时，应自行设置安全且不易被猜到的密码，并妥善保管账号和密码。用户应对使用账号其和密码进行的所有活动负责，包括但不限于发布信息、参与讨论、与其他用户互动等。如因用户自身原因导致账号被盗用或产生其他损害，本论坛将尽力协助用户，但不承担由此产生的任何直接或间接损失。
  3. 用户不得将账号转让、出租、出借或以其他方式允许第三方使用。如本论坛发现账号存在异常使用情况，有权采取暂停账户、限制功能、冻结账户等措施，而无需事先通知用户。
  4. 如果用户发现账号被盗用或存在其他安全问题，应立即告知本论坛，本论坛将及时采取措施协助用户恢复账号安全。

## 四、用户行为规范

  1. 用户在使用本论坛服务时，必须遵守中华人民共和国的相关法律法规，包括但不限于《中华人民共和国民法典》《中华人民共和国著作权法》《中华人民共和国保守国家秘密法》《中华人民共和国计算机信息系统安全保护条例》等。不得利用本论坛进行任何违法活动，包括但不限于发布、传播或存储以下内容：
     * 反对宪法所确定的基本原则的；
     * 危害国家安全，泄露国家秘密，颠覆国家政权，破坏国家统一的；
     * 损害国家荣誉和利益的；
     * 煽动民族仇恨、民族歧视，破坏民族团结的；
     * 破坏国家宗教政策，宣扬邪教和封建迷信的；
     * 散布谣言，扰乱社会秩序，破坏社会稳定的；
     * 散布淫秽、色情、赌博、暴力、凶杀、恐怖或者教唆犯罪的；
     * 侮辱或者诽谤他人，侵害他人合法权益的；
     * 含有法律、行政法规禁止的其他内容的。

  2. 用户应遵循诚实信用原则，不得进行任何虚假、误导性或欺诈性的行为，包括但不限于发布虚假信息、进行虚假交易、冒充他人或组织等。
  3. 用户应尊重他人的知识产权，未经著作权人或其他知识产权权利人的许可，不得复制、传播、修改、删除、演绎、反向工程或以其他方式侵犯他人的作品、商标、专利等知识产权。
  4. 用户在参与论坛讨论时，应保持友好、尊重、包容的态度，不得进行人身攻击、恶意诋毁、辱骂、骚扰或其他不适当的行为。本论坛有权对违反此规定的用户采取警告、禁言、封禁账号等措施。
  5. 用户不得利用本论坛进行任何商业活动，未经本论坛书面授权，不得在本论坛发布广告、推销产品或服务等商业信息。

## 五、内容所有权与使用

  1. 用户在本论坛发布的内容（包括但不限于文字、图片、音频、视频等）版权归原作者所有。用户应保证其发布的内容不侵犯任何第三方的合法权益，包括但不限于知识产权、隐私权、名誉权等。
  2. 本论坛尊重并保护用户的知识产权，用户如发现其他用户发布的内容侵犯其知识产权，可向本论坛提出书面通知，本论坛将按照相关法律法规和本服务条款的规定及时采取措施处理。
  3. 本论坛有权对用户发布的内容进行审查、编辑、删除或移动，而无需事先通知用户。如用户发布的内容违反本服务条款或相关法律法规，本论坛将立即删除该内容，并对相关用户进行处理，同时保留追究用户法律责任的权利。
  4. 本论坛有权对用户发布的内容进行使用，包括但不限于在本论坛内展示、推广、编辑、改编等，但本论坛将尊重用户的署名权，并按照合理的方式标明作者身份。

## 六、隐私政策

  1. 本论坛非常重视用户的隐私保护，将按照本服务条款和本论坛的隐私政策收集、使用和保护用户的个人信息。请用户在使用本论坛服务前，仔细阅读并充分理解隐私政策的全部内容，以了解本论坛如何处理和保护您的个人信息。
  2. 本论坛可能收集用户的以下信息：个人身份信息（如姓名、性别、出生日期、身份证号码等）、联系方式（如电话号码、电子邮箱地址等）、账号信息（如用户名、密码、头像等）、浏览记录、发布内容、设备信息等。收集这些信息的目的包括但不限于为您提供更好的服务、优化本论坛的功能、保护您的账号安全、遵守法律法规等。
  3. 本论坛将采取合理的安全措施保护用户的个人信息，防止信息泄露、改篡或丢失。但请注意，互联网并非绝对安全的环境，尽管本论坛会尽力采取安全措施，但仍无法保证信息的绝对安全。因此，用户在使用本论坛服务时，应自行承担相应的风险，并采取相应的安全措施保护自己的个人信息。
  4. 本论坛不会向任何第三方出售、出租或共享用户的个人信息，除非法律法规要求或本论坛事先获得用户的明确授权。在以下情况下，本论坛可能会披露用户的个人信息：
     * 遵守法律法规或政府机关的要求；
     * 保护本论坛、本论坛的用户或其他第三方的合法权益；
     * 与本论坛的关联公司、合作伙伴或服务提供商共享，以提供本论坛服务或改善本论坛功能；
     * 在本论坛发生合并、收购、资产出售等交易时，将相关用户的个人信息作为交易的一部分转移给新的权利方。

## 七、免责声明

  1. 本论坛按照 “现状” 提供服务，不保证本论坛服务无中断、无错误、无病毒或其他有害成分，也不保证本论坛服务能够满足用户的所有需求。对于因使用本论坛服务而可能产生的任何直接、间接、偶然、特殊或后果性的损害，本论坛不承担任何责任，但本论坛的故意或重大过失除外。
  2. 本论坛不对用户发布的内容的准确性、完整性、可靠性或合法性进行保证。用户应自行判断和评估其他用户发布的内容，并承担相应的风险。如因用户发布的内容导致的任何纠纷或争议，由用户自行解决，本论坛不承担任何责任。
  3. 本论坛可能提供与其他网站或资源的链接，但本论坛不对这些网站或资源的内容、服务质量或安全性负责。用户使用这些网站或资源的风险由用户自行承担，本论坛不承担任何因使用这些网站或资源而产生的责任。

## 八、服务的变更与终止

  1. 本论坛有权随时根据实际情况对本服务条款进行修改和更新，修改后的服务条款将在本论坛公布，自公布之日起生效。如用户不同意修改后的服务条款，可停止使用本论坛服务；如用户继续使用本论坛服务，视为用户已接受修改后的服务条款。
  2. 本论坛有权根据业务发展需要或法律法规的要求，随时暂停、中断或终止本论坛服务的全部或部分功能。在暂停、中断或终止服务前，本论坛将提前通知用户，但因不可抗力或紧急情况除外。
  3. 如用户违反本服务条款的任何规定，本论坛有权随时终止用户使用本论坛服务的资格，而无需事先通知用户。终止服务后，本论坛有权删除用户的账号及相关信息，且不承担任何责任。

## 九、法律适用与争议解决

  1. 本服务条款的订立、执行和解释及争议的解决均适用中华人民共和国法律（不包括香港、澳门特别行政区及台湾地区的法律）。
  2. 如本服务条款的任何条款与中华人民共和国法律相抵触，则该条款应被视为无效，但不影响其他条款的效力。
  3. 用户和本论坛因本服务条款产生的任何争议，应首先通过友好协商解决；协商不成的，任何一方均有权将争议提交至本论坛运营方所在地有管辖权的人民法院诉讼解决。
"""

# 检测并创建 config 文件夹
if not os.path.exists(CONFIG_DIR_NAME):
    os.makedirs(CONFIG_DIR_NAME)

# 检测 config 文件夹下的 other 文件夹
other_dir_path = os.path.join(CONFIG_DIR_NAME, OTHER_DIR_NAME)
if not os.path.exists(other_dir_path):
    os.makedirs(other_dir_path)

# 检测 other 文件夹下的 tos.md 文件
tos_file_path = os.path.join(other_dir_path, TOS_FILE_NAME)
if not os.path.exists(tos_file_path):
    # 写入默认内容到 tos.md 文件
    with open(tos_file_path, 'w', encoding='utf-8') as f:
        f.write(DEFAULT_TOS_CONTENT)

# 存储 TOS 文件的最后修改时间
tos_last_modified = None


def get_tos_content():
    global tos_last_modified

    # 获取当前 TOS 文件的最后修改时间
    current_last_modified = datetime.fromtimestamp(os.path.getmtime(tos_file_path))

    # 如果文件被修改过，则重新读取内容
    if tos_last_modified is None or current_last_modified > tos_last_modified:
        with open(tos_file_path, 'r', encoding='utf-8') as f:
            tos_content = f.read()
        tos_last_modified = current_last_modified
    else:
        # 如果文件未被修改，则使用之前读取的内容
        with open(tos_file_path, 'r', encoding='utf-8') as f:
            tos_content = f.read()

    # 将 Markdown 转换为 HTML
    return markdown.markdown(tos_content, extensions=['tables', 'fenced_code', 'meta', 'toc'])


@tos_bp.route('/')
def tos():
    tos_html = get_tos_content()
    return render_template('other/tos.html', tos_content=tos_html)